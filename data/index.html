<!DOCTYPE html>
<html>

<head>
  <title>Casa Kombi Amora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  <h1>Casa Kombi Amora</h1>
  <p>DUCHA</p>
  <p>
    <button id="btn_shower" class="button" onclick="clickShower()">Ligar</button>
    <!-- <button class="button button2">Desligar</button> -->
  </p>
  <p>
    <span class="sensor-labels">Caixa do Banho</span>
  <div class="water-level-info">
    <!-- <span>Nivel > 30%: </span>
    <span id="lvl-0">1</span> -->
  </div>

  <ul class="water-level-container">

    <li class="water-bottle">
      <div class="cap">
        <div class="cap-top">
        </div>
        <div class="cap-seal">
        </div>
      </div>
      <div class="bottle bottle-1">
        <div id="lvl" class="water-low"> </div>
      </div>
    </li>

    <li class="water-bottle">
      <div class="cap">
        <div class="cap-top">
        </div>
        <div class="cap-seal">
        </div>
      </div>
      <div class="bottle bottle-2">
        <div id="lvl" class="water-medium "> </div>
      </div>
    </li>

    <li class="water-bottle">
      <div class="cap">
        <div class="cap-top">
        </div>
        <div class="cap-seal">
        </div>
      </div>
      <div class="bottle bottle-3">
        <div id="lvl" class="water-mid-full"> </div>
      </div>
    </li>

    <li class="water-bottle">
      <div class="cap">
        <div class="cap-top">
        </div>
        <div class="cap-seal">
        </div>
      </div>
      <div class="bottle bottle-4">
        <div id="lvl" class="water-full"> </div>
      </div>
    </li>
  </ul>
  </p>
  <p>
    <a href="/update"><button class="button">Update OTA</button></a>
    <a href="/edit"><button class="button">Edit Files</button></a>
    <a href="/webserial"><button class="button">WebSerial</button></a>
  </p>
</body>
<script>

  const shower_status = "0";
  const btn_shower = document.querySelector("#btn_shower");

  function clickShower() {
    console.log('clickShower shower_status',shower_status);
    btn_shower.textContent = "Carregando...";
    btn_shower.ariaDisabled = true;
    if (shower_status){
      let send_status = shower_status === "0" ? "1" : "0";
      
      btn_shower.textContent = "Enviando...";
      fetch(`/shower?p=${send_status}`).then(res=>res.json()).then(json=>{
        let text = send_status == "1" ? "Desligar": "Ligar";
        btn_shower.textContent = text;
      }).finally(()=> btn_shower.ariaDisabled = false);
    }
  }

  function setTextShowerButton(new_text, isDisabled = false) {
    if (new_text !=undefined){
      btn_shower.textContent = new_text;
    }

    btn_shower.ariaDisabled = isDisabled;
  }

  function updateShowerButton(new_status) {
    console.log('updateShowerButton new_status',new_status);
    setTextShowerButton("Carregando...",true);
    if (shower_status){
      let send_status = shower_status === "0" ? "1" : "0";
      
      setTextShowerButton("Enviando...",true);

      fetch(`/shower?p=${send_status}`).then(res=>res.json()).then(json=>{
        let text = send_status == "1" ? "Desligar": "Ligar";
        setTextShowerButton(text,false);
      }).finally(()=> {
        btn_shower.ariaDisabled = false
      });
    }
  }

  function updateLevels(arrStatus) {
    const listLvls = document.querySelectorAll("#lvl")
    for (let i = arrStatus.length - 1; i >= 0; i--) {
      const status = arrStatus[i];
      console.log("status", status);
      if (status === 1) {
        listLvls[i].classList.add('water-selected')
      } else {
        listLvls[i].classList.remove('water-selected')
      }
    }
  }

  if (!!window.EventSource) {
    var source = new EventSource('/events');

    source.addEventListener('open', function (e) {
      console.log("Events Connected");
    }, false);
    source.addEventListener('error', function (e) {
      if (e.target.readyState != EventSource.OPEN) {
        console.log("Events Disconnected");
      }
    }, false);

    source.addEventListener('pressure', function (e) {
      console.log("json string", e.data);
      const obj = JSON.parse(e.data);
      updateLevels(obj["cx1"]);
    }, false);

    source.addEventListener('shower_status', function (e) {
      console.log("json string", e.data);
      updateShowerButton(e.data);_
    }, false);

    source.addEventListener('time', function (e) {
      console.log("date time: ", e.data);
    }, false);
  }


  // setInterval(function () {
  //   fetch("/cx1")
  //     .then(function (response) {
  //       return response.json();
  //     })
  //     .then(function (jsonResponse) {
        
  //       const arrStatus = jsonResponse["cx1"];
  //       console.log("arrStatus", arrStatus);
  //       updateLevels(arrStatus);

  //     }).catch(console.err);
  // }, 3000);

  // setInterval(function ( ) {
  //   var xhttp = new XMLHttpRequest();
  //   xhttp.onreadystatechange = function() {
  //     if (this.readyState == 4 && this.status == 200) {
  //       document.getElementById("humidity").innerHTML = this.responseText;
  //     }
  //   };
  //   xhttp.open("GET", "/humidity", true);
  //   xhttp.send();
  // }, 10000 ) ;

  // setInterval(function ( ) {
  //   var xhttp = new XMLHttpRequest();
  //   xhttp.onreadystatechange = function() {
  //     if (this.readyState == 4 && this.status == 200) {
  //       document.getElementById("pressure").innerHTML = this.responseText;
  //     }
  //   };
  //   xhttp.open("GET", "/pressure", true);
  //   xhttp.send();
  // }, 10000 ) ;
</script>

</html>